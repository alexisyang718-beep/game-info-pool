name: 每周报告

on:
  schedule:
    # 每周一 UTC 01:00（北京时间 09:00）运行
    - cron: "0 1 * * 1"
  workflow_dispatch:  # 允许手动触发

jobs:
  weekly-report:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 需要获取所有历史数据文件

      - name: 设置 Python 环境
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: 设置 Node.js 环境
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: 安装 Python 依赖
        run: pip install -r requirements.txt

      - name: 安装 Node.js 依赖
        run: npm install

      - name: 运行周报生成
        env:
          MINIMAX_API_KEY: ${{ secrets.MINIMAX_API_KEY }}
          MINIMAX_GROUP_ID: ${{ secrets.MINIMAX_GROUP_ID }}
          WECOM_WEBHOOK_URL: ${{ secrets.WECOM_WEBHOOK_URL }}
          EMAIL_SMTP_HOST: ${{ secrets.EMAIL_SMTP_HOST }}
          EMAIL_SMTP_PORT: ${{ secrets.EMAIL_SMTP_PORT }}
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
        run: python main_weekly.py

      - name: 提交周报 Excel 到仓库
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add data/
          git diff --staged --quiet || git commit -m "chore: 更新周报 $(date -u '+%Y-%m-%d')"
          git push
