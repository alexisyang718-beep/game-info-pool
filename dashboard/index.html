<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ‰‹æ¸¸æ¦œå•ä»ªè¡¨ç›˜</title>
  <style>
    :root {
      --bg: #f7f8fa;
      --card: #ffffff;
      --surface: #ffffff;
      --border: #e8eaed;
      --text: #1a1a2e;
      --sub: #6b7280;
      --accent: #4f46e5;
      --accent2: #06b6d4;
      --up: #10b981;
      --down: #ef4444;
      --new: #f59e0b;
      --tag-as: #818cf8;
      --tag-gp: #34d399;
      --radius: 10px;
      --shadow: 0 1px 3px rgba(0,0,0,.07), 0 4px 12px rgba(0,0,0,.04);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; font-size: 14px; line-height: 1.6; }

    /* â”€â”€ Header â”€â”€ */
    header { background: var(--card); border-bottom: 1px solid var(--border); padding: 16px 24px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
    header h1 { font-size: 18px; font-weight: 700; letter-spacing: -.3px; }
    header h1 span { color: var(--accent); }
    #last-updated { font-size: 12px; color: var(--sub); }

    /* â”€â”€ Tab Navigation â”€â”€ */
    .page-nav {
      position: sticky; top: 57px; z-index: 90;
      background: var(--bg); border-bottom: 1px solid var(--border);
      padding: 0 24px; display: flex; gap: 4px;
    }
    .nav-btn {
      padding: 10px 20px; border: none; background: none;
      color: var(--sub); cursor: pointer; font-size: 14px;
      border-bottom: 2px solid transparent; transition: all .2s;
    }
    .nav-btn.active { color: var(--accent); border-bottom-color: var(--accent); }
    .nav-btn:hover:not(.active) { color: var(--text); }

    /* â”€â”€ Tab Panels â”€â”€ */
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    /* â”€â”€ Layout â”€â”€ */
    .container { max-width: 1280px; margin: 0 auto; padding: 20px 24px; }

    /* â”€â”€ Stats row â”€â”€ */
    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin-bottom: 24px; }
    .stat-card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; box-shadow: var(--shadow); }
    .stat-card .label { font-size: 12px; color: var(--sub); margin-bottom: 4px; }
    .stat-card .value { font-size: 24px; font-weight: 700; }

    /* â”€â”€ Filters â”€â”€ */
    .filters { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; align-items: center; }
    .filters label { font-size: 12px; color: var(--sub); margin-right: 2px; }
    select, input[type=text] { border: 1px solid var(--border); border-radius: 6px; padding: 6px 10px; font-size: 13px; background: var(--card); color: var(--text); outline: none; transition: border .2s; }
    select:focus, input:focus { border-color: var(--accent); }
    .filter-group { display: flex; align-items: center; gap: 6px; }

    /* â”€â”€ Tabs â”€â”€ */
    .tabs { display: flex; gap: 4px; margin-bottom: 16px; background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 4px; width: fit-content; }
    .tab { padding: 6px 16px; border-radius: 7px; font-size: 13px; font-weight: 500; cursor: pointer; transition: background .15s, color .15s; color: var(--sub); border: none; background: none; }
    .tab.active { background: var(--accent); color: #fff; }

    /* â”€â”€ Table â”€â”€ */
    .table-wrap { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); overflow: hidden; }
    table { width: 100%; border-collapse: collapse; }
    thead th { background: #f3f4f6; font-size: 12px; font-weight: 600; color: var(--sub); text-transform: uppercase; letter-spacing: .5px; padding: 10px 14px; text-align: left; border-bottom: 1px solid var(--border); white-space: nowrap; }
    tbody tr { border-bottom: 1px solid var(--border); transition: background .1s; }
    tbody tr:last-child { border-bottom: none; }
    tbody tr:hover { background: #f9fafb; }
    tbody td { padding: 10px 14px; vertical-align: middle; }
    .rank { font-weight: 700; font-size: 15px; width: 40px; text-align: center; color: var(--sub); }
    .rank.top3 { color: var(--accent); }
    .app-name { font-weight: 600; max-width: 200px; }
    .app-name .artist { font-size: 12px; font-weight: 400; color: var(--sub); display: block; margin-top: 1px; }
    .tag { display: inline-block; padding: 2px 7px; border-radius: 4px; font-size: 11px; font-weight: 600; }
    .tag-as { background: #eef2ff; color: var(--tag-as); }
    .tag-gp { background: #ecfdf5; color: #059669; }
    .tag-free { background: #f0f9ff; color: var(--accent2); }
    .tag-paid { background: #fef3c7; color: #d97706; }
    .tag-gross { background: #fdf4ff; color: #9333ea; }

    /* â”€â”€ Changes section â”€â”€ */
    .section-title { font-size: 16px; font-weight: 700; margin: 28px 0 12px; display: flex; items: center; gap: 8px; }
    .section-title .badge { font-size: 11px; background: var(--accent); color: #fff; padding: 2px 8px; border-radius: 20px; font-weight: 600; }
    .changes-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px; margin-bottom: 28px; }
    .change-card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 14px 16px; box-shadow: var(--shadow); display: flex; flex-direction: column; gap: 6px; }
    .change-card .change-type { font-size: 11px; font-weight: 700; padding: 2px 8px; border-radius: 20px; width: fit-content; }
    .type-new { background: #fef9c3; color: #854d0e; }
    .type-up { background: #dcfce7; color: #166534; }
    .type-down { background: #fee2e2; color: #991b1b; }
    .type-out { background: #f3f4f6; color: var(--sub); }
    .change-card .game-title { font-weight: 600; font-size: 14px; }
    .change-card .meta { font-size: 12px; color: var(--sub); }
    .change-card .delta { font-size: 18px; font-weight: 700; }
    .delta-up { color: var(--up); }
    .delta-down { color: var(--down); }

    /* â”€â”€ AI Analysis â”€â”€ */
    .analysis-box { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px 24px; box-shadow: var(--shadow); line-height: 1.8; }
    .analysis-box h2 { font-size: 15px; font-weight: 700; margin: 16px 0 8px; color: var(--accent); }
    .analysis-box h3 { font-size: 13px; font-weight: 700; margin: 12px 0 6px; color: var(--text); }
    .analysis-box p { margin-bottom: 8px; color: #374151; }
    .analysis-box ul { padding-left: 18px; }
    .analysis-box li { margin-bottom: 4px; }
    .analysis-box strong { color: var(--text); }

    /* â”€â”€ Pagination â”€â”€ */
    .pagination { display: flex; gap: 6px; justify-content: center; margin-top: 16px; flex-wrap: wrap; }
    .page-btn { border: 1px solid var(--border); background: var(--card); border-radius: 6px; padding: 5px 12px; font-size: 13px; cursor: pointer; transition: all .15s; }
    .page-btn:hover { border-color: var(--accent); color: var(--accent); }
    .page-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }

    /* â”€â”€ Market Grid â”€â”€ */
    .market-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 16px;
    }
    .market-card {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 8px; padding: 20px;
    }
    .market-card h3 { margin: 0 0 12px; font-size: 16px; }
    .market-stat { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border); font-size: 13px; }
    .market-stat:last-of-type { border-bottom: none; }
    .market-stat .val { font-weight: 600; color: var(--accent); }
    .genre-bar { margin-top: 12px; }
    .genre-row { display: flex; align-items: center; gap: 8px; margin: 4px 0; font-size: 12px; }
    .genre-fill { height: 8px; border-radius: 4px; background: var(--accent); opacity: 0.7; }
    .market-profile { margin-top: 12px; font-size: 12px; color: var(--sub); line-height: 1.6; }

    /* â”€â”€ Casual Games Tab â”€â”€ */
    .casual-two-col {
      display: grid; grid-template-columns: 1fr 1fr; gap: 16px;
    }
    .casual-rank-row {
      display: flex; align-items: center; gap: 8px;
      padding: 7px 0; border-bottom: 1px solid var(--border); font-size: 13px;
    }
    .casual-rank-row:last-child { border-bottom: none; }
    .casual-rank-num {
      width: 22px; text-align: center; font-weight: 700;
      color: var(--sub); flex-shrink: 0; font-size: 13px;
    }
    .casual-rank-num.top3 { color: var(--accent); }
    .casual-game-info { flex: 1; min-width: 0; }
    .casual-game-name { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .casual-game-dev { font-size: 11px; color: var(--sub); }
    .casual-sub-genre {
      font-size: 11px; padding: 2px 7px;
      background: #f0f9ff; color: var(--accent2);
      border-radius: 4px; white-space: nowrap; flex-shrink: 0;
    }
    .profile-row {
      display: flex; align-items: center; gap: 8px; margin: 6px 0; font-size: 12px;
    }
    .profile-label { width: 72px; color: var(--sub); flex-shrink: 0; }
    .profile-bar-wrap { flex: 1; height: 8px; background: #f3f4f6; border-radius: 4px; overflow: hidden; }
    .profile-bar-fill { height: 100%; border-radius: 4px; }
    .profile-val { width: 36px; text-align: right; font-weight: 600; }
    .casual-stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px; }
    .casual-stat-item { background: var(--bg); border-radius: 8px; padding: 10px 12px; }
    .casual-stat-item .label { font-size: 11px; color: var(--sub); margin-bottom: 2px; }
    .casual-stat-item .value { font-size: 18px; font-weight: 700; }
    .casual-stat-item .value span { font-size: 12px; font-weight: 400; }
    .trend-bar-wrap { display: flex; align-items: flex-end; gap: 6px; height: 96px; margin-top: 12px; }
    .trend-bar-col { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 3px; }
    .trend-bar { width: 100%; background: var(--accent); border-radius: 3px 3px 0 0; opacity: 0.75; }
    .trend-label { font-size: 10px; color: var(--sub); white-space: nowrap; }
    .trend-val { font-size: 11px; font-weight: 600; color: var(--accent); }

    /* â”€â”€ Footer â”€â”€ */
    footer { text-align: center; padding: 24px; color: var(--sub); font-size: 12px; }

    @media (max-width: 640px) {
      .container { padding: 12px 14px; }
      .stats { grid-template-columns: repeat(2, 1fr); }
      .page-nav { padding: 0 14px; }
      .nav-btn { padding: 8px 12px; font-size: 13px; }
      table thead th:nth-child(n+5) { display: none; }
      table tbody td:nth-child(n+5) { display: none; }
      .market-grid { grid-template-columns: 1fr; }
      .casual-two-col { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

<header>
  <h1>ğŸ® æ‰‹æ¸¸<span>æ¦œå•</span>ä»ªè¡¨ç›˜</h1>
  <div id="last-updated">åŠ è½½ä¸­...</div>
</header>

<nav class="page-nav">
  <button class="nav-btn active" onclick="switchTab('charts')">æ¦œå•æ•°æ®</button>
  <button class="nav-btn" onclick="switchTab('market')">å¸‚åœºæ¦‚å†µ</button>
  <button class="nav-btn" onclick="switchTab('device')">è®¾å¤‡æ¦‚å†µ</button>
  <button class="nav-btn" onclick="switchTab('casual')">ä¼‘é—²æ¸¸æˆ</button>
</nav>

<div class="container">
  <!-- Tab Panel: Charts -->
  <div id="tab-charts" class="tab-panel active">
    <!-- Stats -->
    <div class="stats" id="stats-row"></div>

    <!-- AI Analysis -->
    <div class="section-title">AI å¸‚åœºåˆ†æ</div>
    <div class="analysis-box" id="analysis-box"><p style="color:var(--sub)">åŠ è½½ä¸­...</p></div>

    <!-- Changes -->
    <div class="section-title">ä»Šæ—¥å¼‚åŠ¨ <span class="badge" id="change-count">0</span></div>
    <div class="changes-grid" id="changes-grid"></div>

    <!-- Chart Table -->
    <div class="section-title">å®Œæ•´æ¦œå•æ•°æ®</div>

    <div class="filters">
      <div class="filter-group">
        <label>å•†åº—</label>
        <select id="filter-store">
          <option value="">å…¨éƒ¨</option>
          <option value="appstore">App Store</option>
          <option value="google_play">Google Play</option>
        </select>
      </div>
      <div class="filter-group">
        <label>åœ°åŒº</label>
        <select id="filter-region"><option value="">å…¨éƒ¨</option></select>
      </div>
      <div class="filter-group">
        <label>æ¦œå•</label>
        <select id="filter-chart">
          <option value="">å…¨éƒ¨</option>
          <option value="å…è´¹æ¸¸æˆæ¦œ">å…è´¹æ¸¸æˆæ¦œ</option>
          <option value="ä»˜è´¹æ¸¸æˆæ¦œ">ä»˜è´¹æ¸¸æˆæ¦œ</option>
          <option value="ç•…é”€æ¦œ">ç•…é”€æ¦œ</option>
        </select>
      </div>
      <div class="filter-group">
        <label>æœç´¢</label>
        <input type="text" id="filter-search" placeholder="æ¸¸æˆå / å¼€å‘å•†" style="width:160px" />
      </div>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th style="width:50px">æ’å</th>
            <th>æ¸¸æˆ</th>
            <th>å¼€å‘å•†</th>
            <th>åœ°åŒº</th>
            <th>å•†åº—</th>
            <th>æ¦œå•</th>
            <th>è¯„åˆ†</th>
          </tr>
        </thead>
        <tbody id="table-body"></tbody>
      </table>
    </div>
    <div class="pagination" id="pagination"></div>
  </div>

  <!-- Tab Panel: Market Overview -->
  <div id="tab-market" class="tab-panel">
    <div id="market-last-updated" style="color:var(--sub);font-size:13px;margin-bottom:16px"></div>
    <div id="market-grid" class="market-grid"></div>
  </div>

  <!-- Tab Panel: Device Overview -->
  <div id="tab-device" class="tab-panel">
    <div id="device-last-updated" style="color:var(--sub);font-size:13px;margin-bottom:16px"></div>
    <div id="device-grid" class="market-grid"></div>
  </div>

  <!-- Tab Panel: Casual Games Analysis -->
  <div id="tab-casual" class="tab-panel">
    <div id="casual-last-updated" style="color:var(--sub);font-size:13px;margin-bottom:16px"></div>
    <div class="filters" style="margin-bottom:20px">
      <div class="filter-group">
        <label>åœ°åŒº</label>
        <select id="casual-region-select" onchange="renderCasualRegion()"></select>
      </div>
    </div>
    <div class="casual-two-col">
      <div class="market-card" id="casual-top-games-card">
        <h3>çƒ­é—¨ä¼‘é—²æ¸¸æˆ Top 10</h3>
        <div id="casual-top-games-list"></div>
      </div>
      <div class="market-card" id="casual-profile-card">
        <h3>ç”¨æˆ·ç”»åƒ</h3>
        <div id="casual-user-profile"></div>
      </div>
    </div>
    <div class="market-card" style="margin-top:16px;margin-bottom:16px">
      <h3>æ”¶å…¥è¶‹åŠ¿æŒ‡æ•°</h3>
      <div id="casual-revenue-trend"></div>
    </div>
    <div class="analysis-box" id="casual-insight" style="margin-bottom:20px"></div>
  </div>
</div>

<footer>
  æ•°æ®æ¥æºï¼šApp Store iTunes RSS Â· Google Play Â· World Bank Â· IDC/StatCounter è®¾å¤‡æ•°æ® Â· æ¯æ—¥åŒ—äº¬æ—¶é—´ 08:00 è‡ªåŠ¨æ›´æ–°
</footer>

<script>
// â”€â”€ æ•°æ®åŠ è½½ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DATA_URL   = 'data/latest.json';
const CHANGE_URL = 'data/latest_changes.json';
const AI_URL     = 'data/latest_analysis.json';

const PAGE_SIZE = 50;
let allData = [], filtered = [], currentPage = 1;
window._marketLoaded = false;
window._deviceLoaded = false;
window._casualLoaded = false;

async function loadJSON(url) {
  try {
    const r = await fetch(url + '?t=' + Date.now());
    if (!r.ok) return null;
    return await r.json();
  } catch { return null; }
}

async function init() {
  const [chartData, changeData, analysisData] = await Promise.all([
    loadJSON(DATA_URL), loadJSON(CHANGE_URL), loadJSON(AI_URL)
  ]);

  if (chartData) {
    allData = chartData.data || [];
    renderStats(chartData);
    populateRegions(allData);
    applyFilters();
  } else {
    document.getElementById('table-body').innerHTML =
      '<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--sub)">æš‚æ— æ•°æ®ï¼Œè¯·ç­‰å¾…é¦–æ¬¡é‡‡é›†å®Œæˆ</td></tr>';
  }

  renderChanges(changeData?.changes || []);
  renderAnalysis(analysisData?.analysis || '');

  const updated = chartData?.date || analysisData?.date || '';
  document.getElementById('last-updated').textContent =
    updated ? `æ›´æ–°æ—¶é—´ï¼š${updated}` : '';
}

// â”€â”€ Stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderStats(meta) {
  const stats = [
    { label: 'æ€»è®°å½•æ•°',  value: (meta.total || 0).toLocaleString() },
    { label: 'è¦†ç›–åœ°åŒº',  value: meta.regions || 0 },
    { label: 'ä»Šæ—¥æ–°è¿›æ¦œ', value: meta.new_entries || 0 },
    { label: 'ä»Šæ—¥å¼‚åŠ¨',  value: meta.changes || 0 },
  ];
  document.getElementById('stats-row').innerHTML = stats.map(s =>
    `<div class="stat-card"><div class="label">${s.label}</div><div class="value">${s.value}</div></div>`
  ).join('');
}

// â”€â”€ Changes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderChanges(changes) {
  document.getElementById('change-count').textContent = changes.length;
  if (!changes.length) {
    document.getElementById('changes-grid').innerHTML =
      '<p style="color:var(--sub);font-size:13px">ä»Šæ—¥æ— æ˜¾è‘—å¼‚åŠ¨ï¼ˆé¦–æ¬¡è¿è¡Œæˆ–æ•°æ®æœªæ›´æ–°ï¼‰</p>';
    return;
  }
  document.getElementById('changes-grid').innerHTML = changes.slice(0, 24).map(c => {
    const store = c.store === 'google_play' ? 'GP' : 'AS';
    let typeClass = 'type-out', typeLabel = c.change_type;
    if (c.change_type === 'æ–°è¿›æ¦œ') typeClass = 'type-new';
    else if (c.change_type === 'ä¸Šå‡')  typeClass = 'type-up';
    else if (c.change_type === 'ä¸‹é™')  typeClass = 'type-down';

    const deltaHTML = c.rank_delta != null
      ? `<div class="delta ${c.change_type === 'ä¸Šå‡' ? 'delta-up' : 'delta-down'}">
          ${c.change_type === 'ä¸Šå‡' ? 'â†‘' : 'â†“'}${Math.abs(c.rank_delta)}
         </div>`
      : '';

    return `<div class="change-card">
      <span class="change-type ${typeClass}">${typeLabel}</span>
      <div class="game-title">${esc(c.name)}</div>
      <div class="meta">${esc(c.region_name)} Â· ${store} Â· ${esc(c.chart_name)}</div>
      <div class="meta">${c.rank_yesterday != null ? '#'+c.rank_yesterday+' â†’ ' : ''}${c.rank_today != null ? '#'+c.rank_today : ''}</div>
      ${deltaHTML}
    </div>`;
  }).join('');
}

// â”€â”€ Analysis â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAnalysis(text) {
  if (!text || text.includes('æœªé…ç½®')) {
    document.getElementById('analysis-box').innerHTML =
      '<p style="color:var(--sub)">AI åˆ†ææš‚æœªç”Ÿæˆï¼Œè¯·é…ç½® MINIMAX_API_KEY åé‡æ–°è¿è¡Œ</p>';
    return;
  }
  // ç®€å• Markdown â†’ HTML
  let html = text
    .replace(/^## (.+)$/gm, '<h2>$1</h2>')
    .replace(/^### (.+)$/gm, '<h3>$1</h3>')
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/^- (.+)$/gm, '<li>$1</li>')
    .replace(/(<li>.*<\/li>\n?)+/gs, m => '<ul>' + m + '</ul>')
    .replace(/\n{2,}/g, '</p><p>')
    .replace(/\n/g, '<br>');
  document.getElementById('analysis-box').innerHTML = '<p>' + html + '</p>';
}

// â”€â”€ Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function populateRegions(data) {
  const regions = [...new Set(data.map(d => d.region_name))].sort();
  const sel = document.getElementById('filter-region');
  regions.forEach(r => {
    const o = document.createElement('option');
    o.value = r; o.textContent = r;
    sel.appendChild(o);
  });
}

function applyFilters() {
  const store  = document.getElementById('filter-store').value;
  const region = document.getElementById('filter-region').value;
  const chart  = document.getElementById('filter-chart').value;
  const search = document.getElementById('filter-search').value.toLowerCase();

  filtered = allData.filter(d =>
    (!store  || d.store === store) &&
    (!region || d.region_name === region) &&
    (!chart  || d.chart_name === chart) &&
    (!search || d.name?.toLowerCase().includes(search) || d.artist?.toLowerCase().includes(search))
  );

  currentPage = 1;
  renderTable();
  renderPagination();
}

function renderTable() {
  const start = (currentPage - 1) * PAGE_SIZE;
  const rows  = filtered.slice(start, start + PAGE_SIZE);

  const chartTagClass = { 'å…è´¹æ¸¸æˆæ¦œ': 'tag-free', 'ä»˜è´¹æ¸¸æˆæ¦œ': 'tag-paid', 'ç•…é”€æ¦œ': 'tag-gross' };

  document.getElementById('table-body').innerHTML = rows.length
    ? rows.map(d => `<tr>
        <td class="rank ${d.rank <= 3 ? 'top3' : ''}">${d.rank}</td>
        <td class="app-name">${esc(d.name)}<span class="artist">${esc(d.artist||'')}</span></td>
        <td style="color:var(--sub);font-size:13px">${esc(d.artist||'')}</td>
        <td>${esc(d.region_name)}</td>
        <td><span class="tag ${d.store==='google_play'?'tag-gp':'tag-as'}">${d.store==='google_play'?'Google Play':'App Store'}</span></td>
        <td><span class="tag ${chartTagClass[d.chart_name]||''}">${esc(d.chart_name)}</span></td>
        <td>${d.score ? Number(d.score).toFixed(1) : '-'}</td>
      </tr>`).join('')
    : '<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--sub)">æ— åŒ¹é…æ•°æ®</td></tr>';
}

function renderPagination() {
  const total = Math.ceil(filtered.length / PAGE_SIZE);
  const p = document.getElementById('pagination');
  if (total <= 1) { p.innerHTML = ''; return; }

  let html = '';
  const show = (n) => n >= 1 && n <= total;
  const pages = [...new Set([1, currentPage-1, currentPage, currentPage+1, total])].filter(show).sort((a,b)=>a-b);

  pages.forEach((n, i) => {
    if (i > 0 && pages[i] - pages[i-1] > 1) html += '<span style="color:var(--sub);padding:0 4px">â€¦</span>';
    html += `<button class="page-btn ${n===currentPage?'active':''}" onclick="goPage(${n})">${n}</button>`;
  });
  p.innerHTML = `<span style="color:var(--sub);font-size:12px;margin-right:4px">å…±${filtered.length}æ¡</span>` + html;
}

function goPage(n) { currentPage = n; renderTable(); renderPagination(); window.scrollTo(0,0); }

// â”€â”€ Tab Switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(tab) {
  document.querySelectorAll('.tab-panel').forEach(el => el.style.display = 'none');
  document.querySelectorAll('.tab-panel').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
  const target = document.getElementById('tab-' + tab);
  target.style.display = '';
  target.classList.add('active');
  event.currentTarget.classList.add('active');
  if (tab === 'market' && !window._marketLoaded) loadMarket();
  if (tab === 'device' && !window._deviceLoaded) loadDevice();
  if (tab === 'casual' && !window._casualLoaded) loadCasual();
}

// â”€â”€ Market Overview â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadMarket() {
  window._marketLoaded = true;
  fetch('data/market.json?t=' + Date.now())
    .then(r => r.json())
    .then(data => renderMarket(data))
    .catch(() => {
      const grid = document.getElementById('market-grid');
      grid.innerHTML = '<p style="color:var(--sub);padding:40px 0">å¸‚åœºæ•°æ®æš‚æœªç”Ÿæˆ</p>';
    });
}

function renderMarket(data) {
  document.getElementById('market-last-updated').textContent = 'æ•°æ®æ›´æ–°ï¼š' + (data.updated_at || '--');
  const grid = document.getElementById('market-grid');
  if (!data.regions || data.regions.length === 0) {
    grid.innerHTML = '<p style="color:var(--sub);padding:40px 0">æš‚æ— å¸‚åœºæ•°æ®</p>';
    return;
  }
  grid.innerHTML = data.regions.map(r => {
    const genresHTML = (r.genres || []).map(g => {
      const barWidth = Math.min(Math.max(g.pct * 1.5, 8), 100);
      return `<div class="genre-row">
        <span style="width:70px">${esc(g.name)}</span>
        <div class="genre-fill" style="width:${barWidth}px"></div>
        <span>${g.pct}%</span>
      </div>`;
    }).join('');

    const devices = r.estimated_devices
      ? (r.estimated_devices >= 1e9
        ? (r.estimated_devices / 1e9).toFixed(1) + 'B'
        : (r.estimated_devices / 1e6).toFixed(0) + 'M')
      : '--';

    return `<div class="market-card">
      <h3>${esc(r.region_name)}</h3>
      <div class="market-stat"><span>æ‰‹æœºæ™®åŠç‡</span><span class="val">${r.mobile_per_100 ?? '--'} å°/ç™¾äºº</span></div>
      <div class="market-stat"><span>äº’è”ç½‘æ¸—é€ç‡</span><span class="val">${r.internet_pct ?? '--'}%</span></div>
      <div class="market-stat"><span>äººå‡ GDP</span><span class="val">$${r.gdp_per_capita ? r.gdp_per_capita.toLocaleString() : '--'}</span></div>
      <div class="market-stat"><span>ä¼°ç®—ç§»åŠ¨è®¾å¤‡æ•°</span><span class="val">${devices}</span></div>
      ${genresHTML ? `<div class="genre-bar">${genresHTML}</div>` : ''}
      <div class="market-profile">${esc(r.profile || '')}</div>
    </div>`;
  }).join('');
}

// â”€â”€ Device Overview â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadDevice() {
  window._deviceLoaded = true;
  fetch('data/device.json?t=' + Date.now())
    .then(r => r.json())
    .then(data => renderDevice(data))
    .catch(() => {
      document.getElementById('device-grid').innerHTML =
        '<p style="color:var(--sub);padding:40px 0">è®¾å¤‡æ•°æ®æš‚æœªç”Ÿæˆ</p>';
    });
}

function renderDevice(data) {
  document.getElementById('device-last-updated').textContent =
    'æ•°æ®æ›´æ–°ï¼š' + (data.updated_at || '--');
  const grid = document.getElementById('device-grid');
  if (!data.regions || data.regions.length === 0) {
    grid.innerHTML = '<p style="color:var(--sub);padding:40px 0">æš‚æ— è®¾å¤‡æ•°æ®</p>';
    return;
  }
  grid.innerHTML = data.regions.map(r => {
    // OS å æ¯”æ¨ªæ¡
    const iosPct = r.ios_pct ?? 0;
    const adrPct = r.android_pct ?? 0;
    const osBar = `
      <div class="genre-row">
        <span style="width:70px">iOS</span>
        <div class="genre-fill" style="width:${Math.min(iosPct*1.5,100)}px;background:#818cf8"></div>
        <span>${iosPct}%</span>
      </div>
      <div class="genre-row">
        <span style="width:70px">Android</span>
        <div class="genre-fill" style="width:${Math.min(adrPct*1.5,100)}px;background:#34d399"></div>
        <span>${adrPct}%</span>
      </div>`;

    // çƒ­é—¨æœºå‹åˆ—è¡¨
    const devicesHTML = (r.top_devices || []).slice(0, 5).map(d =>
      `<div class="market-stat">
        <span style="flex:1">${esc(d.model)}</span>
        <span class="val">${d.share_pct}%</span>
      </div>`
    ).join('');

    // iOS ç‰ˆæœ¬åˆ†å¸ƒ
    const iosVer = (r.os_versions?.ios || []).map(v =>
      `<div class="genre-row">
        <span style="width:90px;font-size:12px">${esc(v.version)}</span>
        <div class="genre-fill" style="width:${Math.min(v.pct*1.5,100)}px;background:#818cf8;opacity:.7"></div>
        <span>${v.pct}%</span>
      </div>`
    ).join('');

    // Android ç‰ˆæœ¬åˆ†å¸ƒ
    const adrVer = (r.os_versions?.android || []).map(v =>
      `<div class="genre-row">
        <span style="width:90px;font-size:12px">${esc(v.version)}</span>
        <div class="genre-fill" style="width:${Math.min(v.pct*1.5,100)}px;background:#34d399;opacity:.7"></div>
        <span>${v.pct}%</span>
      </div>`
    ).join('');

    return `<div class="market-card">
      <h3>${esc(r.region_name)}</h3>
      <div class="genre-bar" style="margin-bottom:12px">${osBar}</div>
      ${devicesHTML ? `<div style="margin-bottom:8px;font-size:12px;color:var(--sub);font-weight:600">çƒ­é—¨æœºå‹</div>${devicesHTML}` : ''}
      ${iosVer ? `<div style="margin:10px 0 4px;font-size:12px;color:var(--sub);font-weight:600">iOS ç‰ˆæœ¬åˆ†å¸ƒ</div><div class="genre-bar">${iosVer}</div>` : ''}
      ${adrVer ? `<div style="margin:10px 0 4px;font-size:12px;color:var(--sub);font-weight:600">Android ç‰ˆæœ¬åˆ†å¸ƒ</div><div class="genre-bar">${adrVer}</div>` : ''}
      <div class="market-profile">${esc(r.device_notes || '')}</div>
    </div>`;
  }).join('');
}

// â”€â”€ Casual Games Analysis â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let casualData = null;

function loadCasual() {
  window._casualLoaded = true;
  fetch('data/casual.json?t=' + Date.now())
    .then(r => r.json())
    .then(data => {
      casualData = data;
      document.getElementById('casual-last-updated').textContent =
        'æ•°æ®æ›´æ–°ï¼š' + (data.updated_at || '--') + 'ï¼ˆæ¯å­£åº¦äººå·¥æ›´æ–°ï¼‰';
      initCasualRegionSelect(data.regions);
      renderCasualRegion();
    })
    .catch(() => {
      document.getElementById('casual-top-games-card').innerHTML =
        '<p style="color:var(--sub);padding:40px 0">ä¼‘é—²æ¸¸æˆæ•°æ®æš‚æœªç”Ÿæˆ</p>';
    });
}

function initCasualRegionSelect(regions) {
  const sel = document.getElementById('casual-region-select');
  sel.innerHTML = '';
  regions.forEach(r => {
    const o = document.createElement('option');
    o.value = r.region;
    o.textContent = r.region_name;
    sel.appendChild(o);
  });
}

function renderCasualRegion() {
  if (!casualData) return;
  const regionCode = document.getElementById('casual-region-select').value;
  const r = casualData.regions.find(x => x.region === regionCode);
  if (!r) return;
  renderCasualTopGames(r.top_games || []);
  renderCasualUserProfile(r.user_profile || {});
  renderCasualRevenueTrend(r.revenue_trend || []);
  document.getElementById('casual-insight').innerHTML =
    '<p>' + esc(r.insight || 'æš‚æ— åœ°åŒºæ´å¯Ÿ') + '</p>';
}

function renderCasualTopGames(games) {
  const container = document.getElementById('casual-top-games-list');
  if (!games.length) {
    container.innerHTML = '<p style="color:var(--sub)">æš‚æ— æ•°æ®</p>';
    return;
  }
  container.innerHTML = games.map(g => `
    <div class="casual-rank-row">
      <span class="casual-rank-num ${g.rank <= 3 ? 'top3' : ''}">${g.rank}</span>
      <div class="casual-game-info">
        <div class="casual-game-name">${esc(g.name)}</div>
        <div class="casual-game-dev">${esc(g.developer || '')}</div>
      </div>
      <span class="casual-sub-genre">${esc(g.sub_genre || '')}</span>
    </div>`).join('');
}

function renderCasualUserProfile(profile) {
  const container = document.getElementById('casual-user-profile');
  const ageGroups = profile.age_groups || [];
  const maxAgePct = Math.max(...ageGroups.map(a => a.pct), 1);
  const fPct = profile.gender?.female_pct ?? 0;
  const mPct = profile.gender?.male_pct ?? 0;

  const genderBar = `
    <div class="profile-row" style="margin-bottom:10px">
      <span class="profile-label">æ€§åˆ«æ¯”ä¾‹</span>
      <div style="flex:1">
        <div style="display:flex;height:10px;border-radius:5px;overflow:hidden">
          <div style="width:${fPct}%;background:#f472b6"></div>
          <div style="width:${mPct}%;background:#60a5fa"></div>
        </div>
        <div style="display:flex;justify-content:space-between;font-size:11px;margin-top:3px">
          <span style="color:#f472b6">å¥³ ${fPct}%</span>
          <span style="color:#60a5fa">ç”· ${mPct}%</span>
        </div>
      </div>
    </div>`;

  const ageHTML = ageGroups.map(a => `
    <div class="profile-row">
      <span class="profile-label">${esc(a.label)}</span>
      <div class="profile-bar-wrap">
        <div class="profile-bar-fill" style="width:${Math.round(a.pct / maxAgePct * 100)}%;background:var(--accent);opacity:.7"></div>
      </div>
      <span class="profile-val">${a.pct}%</span>
    </div>`).join('');

  const statsHTML = `
    <div class="casual-stats-grid">
      <div class="casual-stat-item">
        <div class="label">æ—¥å‡æ¸¸ç©æ¬¡æ•°</div>
        <div class="value">${profile.sessions_per_day ?? '--'}<span> æ¬¡</span></div>
      </div>
      <div class="casual-stat-item">
        <div class="label">å•æ¬¡æ—¶é•¿</div>
        <div class="value">${profile.session_avg_min ?? '--'}<span> åˆ†é’Ÿ</span></div>
      </div>
      <div class="casual-stat-item">
        <div class="label">ä»˜è´¹è½¬åŒ–ç‡</div>
        <div class="value">${profile.paying_user_pct ?? '--'}<span>%</span></div>
      </div>
      <div class="casual-stat-item">
        <div class="label">æœˆ ARPU</div>
        <div class="value">$${profile.arpu_usd ?? '--'}</div>
      </div>
    </div>`;

  container.innerHTML = genderBar + ageHTML + statsHTML;
}

function renderCasualRevenueTrend(trend) {
  const container = document.getElementById('casual-revenue-trend');
  if (!trend.length) {
    container.innerHTML = '<p style="color:var(--sub)">æš‚æ— è¶‹åŠ¿æ•°æ®</p>';
    return;
  }
  const maxIdx = Math.max(...trend.map(t => t.index), 1);
  const barsHTML = trend.map(t => {
    const barH = Math.round(t.index / maxIdx * 72);
    return `<div class="trend-bar-col">
      <span class="trend-val">${t.index}</span>
      <div class="trend-bar" style="height:${barH}px"></div>
      <span class="trend-label">${esc(t.period)}</span>
    </div>`;
  }).join('');
  container.innerHTML = `
    <div style="font-size:12px;color:var(--sub);margin-bottom:4px">ä»¥2025 Q3ä¸ºåŸºå‡†ï¼ˆ= 100ï¼‰</div>
    <div class="trend-bar-wrap">${barsHTML}</div>`;
}

// â”€â”€ Utility â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function esc(s) {
  return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// â”€â”€ Event listeners â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
['filter-store','filter-region','filter-chart'].forEach(id =>
  document.getElementById(id).addEventListener('change', applyFilters)
);
document.getElementById('filter-search').addEventListener('input', applyFilters);

init();
</script>
</body>
</html>
